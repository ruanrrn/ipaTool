name: Docker Build

on:
  # 手动触发
  workflow_dispatch:
    inputs:
      push_image:
        description: 'Push image to registry'
        required: false
        default: 'true'
        type: boolean
      run_tests:
        description: 'Run tests before building'
        required: false
        default: 'true'
        type: boolean
  # 版本标签触发（如 1.0.0）
  push:
    tags:
      - '*.*.*'
  # 版本变更触发
  repository_dispatch:
    types: [version-changed]
  # Pull Request（仅构建，不推送）
  pull_request:
    branches: [ main, master ]
    paths:
      - 'Dockerfile'
      - 'server/**'
      - 'src/**'
      - 'package.json'

env:
  REGISTRY: docker.io
  IMAGE_NAME: ipa-webtool

jobs:
  # 调试构建（仅在PR或手动触发时）
  debug:
    name: Debug Build
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && inputs.run_tests != 'true')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Display Dockerfile
        run: |
          echo "=== Dockerfile Content ==="
          cat Dockerfile

      - name: Display Cargo.toml
        run: |
          echo "=== Cargo.toml Content ==="
          cat server/Cargo.toml

      - name: Display package.json
        run: |
          echo "=== package.json Content ==="
          cat package.json

      - name: Build frontend (debug)
        run: |
          echo "=== Building frontend ==="
          docker run --rm -v "$(pwd)":/app -w /app node:18-alpine sh -c "
            npm install -g pnpm@8
            pnpm install --frozen-lockfile
            pnpm run build
            ls -la dist/
          "

      - name: Build backend (debug)
        run: |
          echo "=== Building backend ==="
          docker run --rm -v "$(pwd)":/app -w /app rust:1.83-slim sh -c "
            apt-get update && apt-get install -y pkg-config libssl-dev
            cargo build --release --manifest-path=server/Cargo.toml
            ls -la server/target/release/
          "

      - name: Test full Docker build (no push)
        run: |
          echo "=== Testing full Docker build ==="
          docker build -t ipa-webtool:debug .
          docker images ipa-webtool:debug

  # 生产构建
  build:
    name: Build and Push
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request'
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request' && (github.event_name == 'push' || inputs.push_image == 'true')
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKER_USERNAME != '' && format('{0}/{1}', secrets.DOCKER_USERNAME, env.IMAGE_NAME) || format('heard/{0}', env.IMAGE_NAME) }}
          tags: |
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-,format=short

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' && (github.event_name == 'push' || inputs.push_image == 'true') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          provenance: false

      - name: Run Trivy vulnerability scanner
        if: github.event_name != 'pull_request' && (github.event_name == 'push' || inputs.push_image == 'true')
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ secrets.DOCKER_USERNAME != '' && format('{0}/{1}', secrets.DOCKER_USERNAME, env.IMAGE_NAME) || format('heard/{0}', env.IMAGE_NAME) }}:latest
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security tab
        if: always() && github.event_name != 'pull_request'
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'docker-image'

      - name: Image digest
        run: echo "Image pushed with digest ${{ steps.meta.outputs.digest }}"
